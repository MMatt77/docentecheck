<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTN - Centro de e-Learning | Analizador de Logs Moodle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --utn-red: #E31E24;
            --utn-dark-red: #B71C1C;
            --utn-gray: #333333;
            --utn-light-gray: #666666;
            --utn-bg-gray: #F5F5F5;
            --utn-white: #FFFFFF;
            --utn-shadow: rgba(227, 30, 36, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--utn-bg-gray) 0%, #E8E8E8 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--utn-gray);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--utn-white);
            border-radius: 15px;
            box-shadow: 0 20px 40px var(--utn-shadow);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--utn-gray) 0%, var(--utn-red) 100%);
            color: var(--utn-white);
            padding: 30px;
            text-align: center;
        }

        .utn-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .utn-logo-icon {
            font-size: 2.5rem;
            color: var(--utn-white);
            margin-right: 15px;
            font-weight: bold;
        }

        .utn-logo-text {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .utn-logo-main {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .utn-logo-sub {
            font-size: 1.1rem;
            color: var(--utn-red);
            background: var(--utn-white);
            padding: 2px 8px;
            border-radius: 3px;
            margin-top: 5px;
            font-weight: 600;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed var(--utn-red);
            border-radius: 15px;
            padding: 60px 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #FDF5F5;
        }

        .upload-area:hover {
            border-color: var(--utn-dark-red);
            background: #FFF0F0;
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--utn-red);
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, var(--utn-red) 0%, var(--utn-dark-red) 100%);
            color: var(--utn-white);
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 10px;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px var(--utn-shadow);
        }

        #fileInput {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--utn-bg-gray);
            border-top: 4px solid var(--utn-red);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            padding: 40px;
        }

        .teacher-info {
            background: linear-gradient(135deg, var(--utn-red) 0%, var(--utn-dark-red) 100%);
            color: var(--utn-white);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--utn-white);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px var(--utn-shadow);
            border-left: 5px solid var(--utn-red);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--utn-red);
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--utn-light-gray);
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .chart-container {
            background: var(--utn-white);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px var(--utn-shadow);
            border-top: 4px solid var(--utn-red);
        }

        .chart-title {
            font-size: 1.5rem;
            color: var(--utn-gray);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .chart-container canvas {
            max-height: 400px;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--utn-white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--utn-shadow);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--utn-bg-gray);
        }

        th {
            background: linear-gradient(135deg, var(--utn-red) 0%, var(--utn-dark-red) 100%);
            color: var(--utn-white);
            font-weight: 600;
        }

        tr:hover {
            background: #FDF5F5;
        }

        .alert {
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid;
            font-weight: 500;
        }

        .alert-error {
            background: #FFEBEE;
            border-color: var(--utn-red);
            color: var(--utn-dark-red);
        }

        .alert-success {
            background: #E8F5E8;
            border-color: #4CAF50;
            color: #2E7D32;
        }

        .export-buttons {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: var(--utn-bg-gray);
            border-radius: 10px;
        }

        .btn-export {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: var(--utn-white);
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 8px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(76, 175, 80, 0.3);
        }

        .btn-csv {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .btn-csv:hover {
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.3);
        }

        .btn-reload {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .btn-reload:hover {
            box-shadow: 0 8px 16px rgba(33, 150, 243, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="utn-logo">
                <div class="utn-logo-icon">‚ú±</div>
                <div class="utn-logo-text">
                    <div class="utn-logo-main">UTN</div>
                    <div class="utn-logo-sub">Centro de e-Learning</div>
                </div>
            </div>
            <h1>üìä Analizador de Logs Moodle</h1>
            <p>An√°lisis autom√°tico de actividad docente en plataforma educativa</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÅ</div>
                <div style="font-size: 1.3rem; color: var(--utn-gray); margin-bottom: 10px;">
                    Arrastra tu archivo Excel aqu√≠
                </div>
                <div style="color: var(--utn-light-gray); font-size: 1rem;">
                    o haz clic para seleccionar el archivo
                </div>
                <button class="btn" type="button">
                    Seleccionar Archivo
                </button>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls" />
            <div style="margin-top: 15px; color: var(--utn-light-gray);">
                Formatos compatibles: .xlsx, .xls | M√°ximo 10MB
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>Procesando archivo...</h3>
            <p>Analizando datos de actividad docente</p>
        </div>

        <div class="results" id="results">
            <!-- Los resultados se cargar√°n aqu√≠ -->
        </div>
    </div>

    <script>
        // Variables globales
        var globalData = null;
        var currentStats = null;
        var courseInfo = null;
        var teacherName = null;

        // Funci√≥n para mostrar alertas
        function showAlert(message, type) {
            var alerts = document.querySelectorAll('.alert');
            for (var i = 0; i < alerts.length; i++) {
                alerts[i].remove();
            }

            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type;
            alertDiv.innerHTML = '<strong>' + (type === 'error' ? '‚ùå Error:' : '‚úÖ √âxito:') + '</strong> ' + message;

            var uploadSection = document.querySelector('.upload-section');
            if (uploadSection) {
                uploadSection.appendChild(alertDiv);
            }

            setTimeout(function() {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Funci√≥n para mostrar/ocultar loading
        function showLoading(show) {
            var loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }

        // Funci√≥n para manejar archivo
        function handleFile(file) {
            console.log('Procesando archivo:', file.name);

            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showAlert('Por favor selecciona un archivo Excel v√°lido', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showAlert('El archivo es demasiado grande. M√°ximo 10MB', 'error');
                return;
            }

            showLoading(true);

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    var worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

                    console.log('Datos extra√≠dos, filas:', jsonData.length);
                    globalData = jsonData;
                    processData(jsonData);
                } catch (error) {
                    console.error('Error procesando archivo:', error);
                    showAlert('Error al procesar el archivo Excel', 'error');
                    showLoading(false);
                }
            };

            reader.onerror = function() {
                showAlert('Error al leer el archivo', 'error');
                showLoading(false);
            };

            reader.readAsArrayBuffer(file);
        }

        // Funci√≥n para procesar datos
        function processData(data) {
            try {
                if (data.length < 2) {
                    throw new Error('El archivo no contiene suficientes datos');
                }

                var logs = data.slice(1);
                var teacherStats = {};
                var courseInfoTemp = {
                    courseName: 'No identificado',
                    period: 'No identificado',
                    reportDate: new Date().toLocaleDateString('es-AR')
                };

                // Primera pasada: encontrar el per√≠odo global
                var allDates = [];
                for (var i = 0; i < logs.length; i++) {
                    var log = logs[i];
                    if (!log || log.length < 2) continue;

                    var timestamp = log[0];
                    var contextEvent = log[3];

                    // Extraer nombre del curso
                    if (contextEvent && contextEvent.includes('Curso:') && courseInfoTemp.courseName === 'No identificado') {
                        var match = contextEvent.match(/Curso:\s*(.+)/);
                        if (match) {
                            courseInfoTemp.courseName = match[1].trim();
                        }
                    }

                    // Recopilar todas las fechas
                    if (timestamp && timestamp.includes(',')) {
                        var parts = timestamp.split(',');
                        var datePart = parts[0].trim();
                        var dateParts = datePart.split('/');
                        if (dateParts.length === 3) {
                            var day = parseInt(dateParts[0]);
                            var month = parseInt(dateParts[1]);
                            var year = parseInt(dateParts[2]);
                            if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                                var fullDate = new Date(2000 + year, month - 1, day);
                                allDates.push(fullDate);
                            }
                        }
                    }
                }

                // Calcular per√≠odo global
                var totalDaysInPeriod = 1;
                if (allDates.length > 0) {
                    allDates.sort(function(a, b) { return a - b; });
                    var firstDate = allDates[0];
                    var lastDate = allDates[allDates.length - 1];
                    var diffTime = lastDate.getTime() - firstDate.getTime();
                    totalDaysInPeriod = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    var firstStr = firstDate.getDate().toString().padStart(2, '0') + '/' + 
                                  (firstDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                  firstDate.getFullYear();
                    var lastStr = lastDate.getDate().toString().padStart(2, '0') + '/' + 
                                 (lastDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                 lastDate.getFullYear();
                    courseInfoTemp.period = firstStr + ' - ' + lastStr;
                }

                // Segunda pasada: procesar datos por docente
                for (var i = 0; i < logs.length; i++) {
                    var log = logs[i];
                    if (!log || log.length < 2) continue;

                    var timestamp = log[0];
                    var teacherNameTemp = log[1];
                    var eventName = log[5] || 'Sin especificar';

                    if (!teacherNameTemp || teacherNameTemp.trim() === '' || teacherNameTemp === '-') {
                        continue;
                    }

                    if (!teacherStats[teacherNameTemp]) {
                        teacherStats[teacherNameTemp] = {
                            totalEntries: 0,
                            entriesPerDay: {},
                            entriesPerMonth: {},
                            activityByWeekday: {},
                            eventTypes: {},
                            totalDaysInPeriod: totalDaysInPeriod
                        };
                    }

                    var stats = teacherStats[teacherNameTemp];
                    stats.totalEntries++;
                    stats.eventTypes[eventName] = (stats.eventTypes[eventName] || 0) + 1;

                    if (timestamp && timestamp.includes(',')) {
                        var parts = timestamp.split(',');
                        var datePart = parts[0].trim();
                        var dateParts = datePart.split('/');
                        var day = dateParts[0];
                        var month = dateParts[1];
                        var year = dateParts[2];

                        var normalizedDate = day.padStart(2, '0') + '/' + month.padStart(2, '0') + '/20' + year;
                        var monthYear = month.padStart(2, '0') + '/20' + year;

                        stats.entriesPerDay[normalizedDate] = (stats.entriesPerDay[normalizedDate] || 0) + 1;
                        stats.entriesPerMonth[monthYear] = (stats.entriesPerMonth[monthYear] || 0) + 1;

                        var date = new Date(2000 + parseInt(year), parseInt(month) - 1, parseInt(day));
                        var weekdays = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                        var weekday = weekdays[date.getDay()];
                        stats.activityByWeekday[weekday] = (stats.activityByWeekday[weekday] || 0) + 1;
                    }
                }

                console.log('Docentes encontrados:', Object.keys(teacherStats));

                if (Object.keys(teacherStats).length === 0) {
                    throw new Error('No se encontraron datos de actividad docente');
                }

                showResults(teacherStats, courseInfoTemp);
                showLoading(false);

            } catch (error) {
                console.error('Error en processData:', error);
                showAlert('Error al analizar los datos: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // Funci√≥n para mostrar resultados
        function showResults(teacherStats, courseInfoParam) {
            console.log('Iniciando showResults');
            
            var teacherNames = Object.keys(teacherStats);
            var firstTeacher = teacherNames[0];
            currentStats = teacherStats[firstTeacher];
            
            // Asignar variables globales
            courseInfo = courseInfoParam;
            teacherName = firstTeacher;

            var totalDaysActive = Object.keys(currentStats.entriesPerDay).length;
            var totalDaysInPeriod = currentStats.totalDaysInPeriod;
            var percentageActiveDays = ((totalDaysActive / totalDaysInPeriod) * 100).toFixed(1);
            var avgEntriesPerPeriod = (currentStats.totalEntries / totalDaysInPeriod).toFixed(1);

            console.log('Datos calculados correctamente');

            // Limpiar y obtener contenedor
            var resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'block';

            // 1. Header del docente
            var headerDiv = document.createElement('div');
            headerDiv.className = 'teacher-info';
            
            var headerH2 = document.createElement('h2');
            headerH2.textContent = 'üë®‚Äçüè´ ' + firstTeacher;
            headerDiv.appendChild(headerH2);
            
            var headerH3 = document.createElement('h3');
            headerH3.textContent = 'üìö ' + courseInfo.courseName;
            headerDiv.appendChild(headerH3);
            
            var headerP1 = document.createElement('p');
            headerP1.innerHTML = '<strong>üìÖ Per√≠odo Evaluado:</strong> ' + courseInfo.period;
            headerDiv.appendChild(headerP1);
            
            var headerP2 = document.createElement('p');
            headerP2.innerHTML = '<strong>üìä Fecha del Reporte:</strong> ' + courseInfo.reportDate;
            headerDiv.appendChild(headerP2);
            
            resultsContainer.appendChild(headerDiv);
            console.log('Header creado');

            // 2. Estad√≠sticas principales
            var statsGrid = document.createElement('div');
            statsGrid.className = 'stats-grid';
            
            // Crear 4 tarjetas de estad√≠sticas
            var statData = [
                { number: currentStats.totalEntries.toLocaleString(), label: 'Total de Acciones' },
                { number: avgEntriesPerPeriod, label: 'Promedio del Per√≠odo' },
                { number: percentageActiveDays + '%', label: 'D√≠as Activos' },
                { number: totalDaysInPeriod - totalDaysActive, label: 'D√≠as Sin Actividad' }
            ];

            for (var i = 0; i < statData.length; i++) {
                var card = document.createElement('div');
                card.className = 'stat-card';
                
                var number = document.createElement('div');
                number.className = 'stat-number';
                number.textContent = statData[i].number;
                card.appendChild(number);
                
                var label = document.createElement('div');
                label.className = 'stat-label';
                label.textContent = statData[i].label;
                card.appendChild(label);
                
                statsGrid.appendChild(card);
            }
            
            resultsContainer.appendChild(statsGrid);
            console.log('Estad√≠sticas creadas');

            // 3. Secci√≥n explicativa detallada (COMPLETADA)
            var explanationSection = document.createElement('div');
            explanationSection.className = 'chart-container';
            
            var explanationTitle = document.createElement('div');
            explanationTitle.className = 'chart-title';
            explanationTitle.textContent = '‚ÑπÔ∏è ¬øQu√© Representan Estos Datos?';
            explanationSection.appendChild(explanationTitle);

            var explanationContent = document.createElement('div');
            explanationContent.style.cssText = 'background: #FDF5F5; padding: 25px; border-radius: 12px; border-left: 5px solid var(--utn-red);';
            
            var explanationHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px;">';
            
            // Tarjeta 1: Total de Acciones
            explanationHTML += '<div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #4CAF50; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
            explanationHTML += '<h4 style="color: var(--utn-red); margin-bottom: 12px; display: flex; align-items: center;"><span style="margin-right: 8px;">üéØ</span>Total de Acciones Pedag√≥gicas</h4>';
            explanationHTML += '<p style="margin: 8px 0; font-size: 0.95rem; line-height: 1.5;">Cada "acci√≥n" representa una <strong>actividad pedag√≥gica espec√≠fica</strong> registrada autom√°ticamente por Moodle cuando el docente crea contenidos, califica trabajos, gestiona actividades, supervisa estudiantes o navega por el curso.</p>';
            explanationHTML += '<p style="margin: 8px 0 0 0; font-size: 0.9rem; font-weight: 600; color: var(--utn-red);">üí° No son clics simples, sino eventos educativos registrados por el sistema.</p>';
            explanationHTML += '</div>';

            // Tarjeta 2: Promedio del Per√≠odo
            explanationHTML += '<div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #FF9800; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
            explanationHTML += '<h4 style="color: var(--utn-red); margin-bottom: 12px; display: flex; align-items: center;"><span style="margin-right: 8px;">üìÖ</span>Promedio General del Per√≠odo</h4>';
            explanationHTML += '<p style="margin: 8px 0; font-size: 0.95rem; line-height: 1.5;">Se calcula considerando <strong>TODOS los d√≠as</strong> del per√≠odo evaluado (' + totalDaysInPeriod + ' d√≠as), incluyendo d√≠as sin actividad registrada.</p>';
            explanationHTML += '<p style="margin: 8px 0; font-size: 0.95rem; background: #FFF3E0; padding: 10px; border-radius: 6px;">üìä <strong>Resultado:</strong> ' + avgEntriesPerPeriod + ' acciones por d√≠a</p>';
            explanationHTML += '<p style="margin: 8px 0 0 0; font-size: 0.9rem; color: #E65100;"><strong>Refleja la frecuencia real</strong> de uso de la plataforma durante todo el per√≠odo.</p>';
            explanationHTML += '</div>';

            // Tarjeta 3: D√≠as Activos vs Total
            explanationHTML += '<div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #2196F3; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
            explanationHTML += '<h4 style="color: var(--utn-red); margin-bottom: 12px; display: flex; align-items: center;"><span style="margin-right: 8px;">üìà</span>Continuidad de Uso</h4>';
            explanationHTML += '<p style="margin: 8px 0; font-size: 0.95rem; line-height: 1.5;">Del total de <strong>' + totalDaysInPeriod + ' d√≠as</strong> del per√≠odo analizado, hubo actividad en <strong>' + totalDaysActive + ' d√≠as</strong> (' + percentageActiveDays + '%).</p>';
            explanationHTML += '<p style="margin: 8px 0 0 0; font-size: 0.9rem; font-weight: 600; color: var(--utn-red);">üéØ Continuidad: ' + percentageActiveDays + '% del per√≠odo total</p>';
            explanationHTML += '</div>';

            // Tarjeta 4: Nivel de Engagement (COMPLETADA)
            var percentageNum = parseFloat(percentageActiveDays);
            var engagementLevel, engagementColor, engagementIcon, engagementDescription;
            
            if (percentageNum > 50) {
                engagementLevel = 'ALTO';
                engagementColor = '#E31E24';
                engagementIcon = 'üî•';
                engagementDescription = 'El docente mantiene una presencia <strong>constante y regular</strong> en la plataforma.';
            } else if (percentageNum > 25) {
                engagementLevel = 'MODERADO';
                engagementColor = '#FF9800';
                engagementIcon = 'üìä';
                engagementDescription = 'El docente muestra un uso <strong>moderado</strong> de la plataforma.';
            } else {
                engagementLevel = 'BAJO';
                engagementColor = '#9E9E9E';
                engagementIcon = 'üìâ';
                engagementDescription = 'El docente tiene un uso <strong>espor√°dico</strong> de la plataforma.';
            }

            explanationHTML += '<div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid ' + engagementColor + '; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
            explanationHTML += '<h4 style="color: var(--utn-red); margin-bottom: 12px; display: flex; align-items: center;"><span style="margin-right: 8px;">' + engagementIcon + '</span>Nivel de Engagement</h4>';
            explanationHTML += '<p style="margin: 8px 0; font-size: 0.95rem; line-height: 1.5;">' + engagementDescription + '</p>';
            explanationHTML += '<p style="margin: 8px 0 0 0; font-size: 0.9rem; font-weight: 600; color: ' + engagementColor + ';">üìä Nivel: ' + engagementLevel + '</p>';
            explanationHTML += '</div>';

            explanationHTML += '</div>'; // Cierre del grid

            // Agregar nota metodol√≥gica
            explanationHTML += '<div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--utn-red); margin-top: 15px;">';
            explanationHTML += '<h4 style="color: var(--utn-red); margin-bottom: 12px; text-align: center;">üìã Nota Metodol√≥gica</h4>';
            explanationHTML += '<p style="margin: 8px 0; font-size: 0.9rem; line-height: 1.5; text-align: justify;">Este an√°lisis se basa en los <strong>logs autom√°ticos de Moodle</strong>, que registran cada interacci√≥n pedag√≥gica del docente con la plataforma. Los datos incluyen actividades como creaci√≥n de contenidos, gesti√≥n de calificaciones, supervisi√≥n de estudiantes, y navegaci√≥n por recursos educativos. El an√°lisis considera el per√≠odo completo para calcular promedios reales de uso.</p>';
            explanationHTML += '</div>';

            explanationContent.innerHTML = explanationHTML;
            explanationSection.appendChild(explanationContent);
            resultsContainer.appendChild(explanationSection);

            // 4. Gr√°ficos de actividad
            createActivityCharts();

            // 5. Tabla de eventos m√°s frecuentes
            createEventTable();

            // 6. Botones de exportaci√≥n
            createExportButtons();

            console.log('Resultados mostrados completamente');
        }

        // Funci√≥n para crear gr√°ficos de actividad
        function createActivityCharts() {
            // Gr√°fico de actividad por d√≠a de la semana
            var weekdayChartContainer = document.createElement('div');
            weekdayChartContainer.className = 'chart-container';
            
            var weekdayTitle = document.createElement('div');
            weekdayTitle.className = 'chart-title';
            weekdayTitle.textContent = 'üìÖ Actividad por D√≠a de la Semana';
            weekdayChartContainer.appendChild(weekdayTitle);

            var weekdayCanvas = document.createElement('canvas');
            weekdayCanvas.id = 'weekdayChart';
            weekdayChartContainer.appendChild(weekdayCanvas);

            document.getElementById('results').appendChild(weekdayChartContainer);

            // Preparar datos para el gr√°fico
            var weekdays = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            var weekdayData = weekdays.map(function(day) {
                return currentStats.activityByWeekday[day] || 0;
            });

            var weekdayCtx = weekdayCanvas.getContext('2d');
            new Chart(weekdayCtx, {
                type: 'bar',
                data: {
                    labels: weekdays,
                    datasets: [{
                        label: 'Acciones por d√≠a',
                        data: weekdayData,
                        backgroundColor: [
                            '#E31E24', '#FF5722', '#FF9800', '#FFC107',
                            '#4CAF50', '#2196F3', '#9C27B0'
                        ],
                        borderColor: '#333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'N√∫mero de Acciones'
                            }
                        }
                    }
                }
            });

            // Gr√°fico de actividad mensual
            if (Object.keys(currentStats.entriesPerMonth).length > 1) {
                var monthlyChartContainer = document.createElement('div');
                monthlyChartContainer.className = 'chart-container';
                
                var monthlyTitle = document.createElement('div');
                monthlyTitle.className = 'chart-title';
                monthlyTitle.textContent = 'üìä Evoluci√≥n Mensual de Actividad';
                monthlyChartContainer.appendChild(monthlyTitle);

                var monthlyCanvas = document.createElement('canvas');
                monthlyCanvas.id = 'monthlyChart';
                monthlyChartContainer.appendChild(monthlyCanvas);

                document.getElementById('results').appendChild(monthlyChartContainer);

                // Preparar datos mensuales
                var monthlyEntries = Object.entries(currentStats.entriesPerMonth).sort();
                var monthLabels = monthlyEntries.map(function(entry) { return entry[0]; });
                var monthData = monthlyEntries.map(function(entry) { return entry[1]; });

                var monthlyCtx = monthlyCanvas.getContext('2d');
                new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'Acciones por mes',
                            data: monthData,
                            borderColor: '#E31E24',
                            backgroundColor: 'rgba(227, 30, 36, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'N√∫mero de Acciones'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funci√≥n para crear tabla de eventos
        function createEventTable() {
            var tableContainer = document.createElement('div');
            tableContainer.className = 'chart-container';
            
            var tableTitle = document.createElement('div');
            tableTitle.className = 'chart-title';
            tableTitle.textContent = 'üìã Tipos de Actividades M√°s Frecuentes';
            tableContainer.appendChild(tableTitle);

            // Ordenar eventos por frecuencia
            var sortedEvents = Object.entries(currentStats.eventTypes)
                .sort(function(a, b) { return b[1] - a[1]; })
                .slice(0, 10); // Top 10

            var table = document.createElement('table');
            
            // Header
            var thead = document.createElement('thead');
            var headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Tipo de Actividad</th><th>Cantidad</th><th>Porcentaje</th>';
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Body
            var tbody = document.createElement('tbody');
            for (var i = 0; i < sortedEvents.length; i++) {
                var event = sortedEvents[i];
                var percentage = ((event[1] / currentStats.totalEntries) * 100).toFixed(1);
                
                var row = document.createElement('tr');
                row.innerHTML = '<td>' + event[0] + '</td><td>' + event[1] + '</td><td>' + percentage + '%</td>';
                tbody.appendChild(row);
            }
            table.appendChild(tbody);

            tableContainer.appendChild(table);
            document.getElementById('results').appendChild(tableContainer);
        }

        // Funci√≥n para crear botones de exportaci√≥n
        function createExportButtons() {
            var exportDiv = document.createElement('div');
            exportDiv.className = 'export-buttons';
            
            var exportTitle = document.createElement('h3');
            exportTitle.textContent = 'üì§ Exportar Resultados';
            exportTitle.style.marginBottom = '20px';
            exportDiv.appendChild(exportTitle);

            // Bot√≥n PDF
            var pdfBtn = document.createElement('button');
            pdfBtn.className = 'btn-export';
            pdfBtn.innerHTML = 'üìÑ Exportar PDF';
            pdfBtn.onclick = exportToPDF;
            exportDiv.appendChild(pdfBtn);

            // Bot√≥n CSV
            var csvBtn = document.createElement('button');
            csvBtn.className = 'btn-export btn-csv';
            csvBtn.innerHTML = 'üìä Exportar CSV';
            csvBtn.onclick = exportToCSV;
            exportDiv.appendChild(csvBtn);

            // Bot√≥n recargar
            var reloadBtn = document.createElement('button');
            reloadBtn.className = 'btn-export btn-reload';
            reloadBtn.innerHTML = 'üîÑ Analizar Otro Archivo';
            reloadBtn.onclick = function() {
                location.reload();
            };
            exportDiv.appendChild(reloadBtn);

            document.getElementById('results').appendChild(exportDiv);
        }

        // Funci√≥n para exportar a PDF mejorado con gr√°ficos
        function exportToPDF() {
            try {
                showAlert('Generando reporte PDF completo...', 'success');
                
                var jsPDF = window.jspdf.jsPDF;
                var doc = new jsPDF('p', 'mm', 'a4'); // Portrait, mil√≠metros, A4
                var pageWidth = doc.internal.pageSize.getWidth();
                var pageHeight = doc.internal.pageSize.getHeight();
                var margin = 20;
                var contentWidth = pageWidth - (margin * 2);
                
                // Configurar fuentes y colores
                var primaryColor = '#E31E24';
                var secondaryColor = '#666666';
                var lightGray = '#F5F5F5';
                
                // ===== P√ÅGINA 1: PORTADA Y RESUMEN EJECUTIVO =====
                
                // Header UTN con logo simulado
                doc.setFillColor(227, 30, 36); // Color UTN rojo
                doc.rect(0, 0, pageWidth, 35, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('UTN', margin, 20);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Centro de e-Learning', margin, 28);
                
                // T√≠tulo principal
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('REPORTE DE ACTIVIDAD DOCENTE', margin, 55);
                doc.text('PLATAFORMA MOODLE', margin, 67);
                
                // L√≠nea decorativa
                doc.setLineWidth(2);
                doc.setDrawColor(227, 30, 36);
                doc.line(margin, 75, pageWidth - margin, 75);
                
                // Informaci√≥n del docente en recuadro
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, 85, contentWidth, 45, 3, 3, 'F');
                
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('INFORMACI√ìN DEL DOCENTE', margin + 10, 100);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text('Docente:', margin + 10, 110);
                doc.setFont(undefined, 'bold');
                doc.text(teacherName, margin + 35, 110);
                
                doc.setFont(undefined, 'normal');
                doc.text('Curso:', margin + 10, 118);
                doc.setFont(undefined, 'bold');
                doc.text(courseInfo.courseName, margin + 30, 118);
                
                doc.setFont(undefined, 'normal');
                doc.text('Per√≠odo Evaluado:', margin + 10, 126);
                doc.setFont(undefined, 'bold');
                doc.text(courseInfo.period, margin + 50, 126);
                
                // Calcular m√©tricas principales
                var totalDaysActive = Object.keys(currentStats.entriesPerDay).length;
                var totalDaysInPeriod = currentStats.totalDaysInPeriod;
                var percentageActiveDays = ((totalDaysActive / totalDaysInPeriod) * 100).toFixed(1);
                var avgEntriesPerPeriod = (currentStats.totalEntries / totalDaysInPeriod).toFixed(1);
                var avgEntriesPerActiveDay = (currentStats.totalEntries / totalDaysActive).toFixed(1);
                
                // Determinar nivel de engagement
                var percentageNum = parseFloat(percentageActiveDays);
                var engagementLevel, engagementColor;
                if (percentageNum > 50) {
                    engagementLevel = 'ALTO';
                    engagementColor = '#4CAF50';
                } else if (percentageNum > 25) {
                    engagementLevel = 'MODERADO';
                    engagementColor = '#FF9800';
                } else {
                    engagementLevel = 'BAJO';
                    engagementColor = '#F44336';
                }
                
                // Resumen ejecutivo en tarjetas
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(227, 30, 36);
                doc.text('RESUMEN EJECUTIVO', margin, 150);
                
                // Tarjeta 1: Total de actividades
                doc.setFillColor(76, 175, 80);
                doc.roundedRect(margin, 160, 40, 25, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text(currentStats.totalEntries.toLocaleString(), margin + 20, 170, {align: 'center'});
                doc.setFontSize(8);
                doc.text('TOTAL ACCIONES', margin + 20, 180, {align: 'center'});
                
                // Tarjeta 2: Promedio por d√≠a
                doc.setFillColor(255, 152, 0);
                doc.roundedRect(margin + 45, 160, 40, 25, 2, 2, 'F');
                doc.setFontSize(20);
                doc.text(avgEntriesPerPeriod, margin + 65, 170, {align: 'center'});
                doc.setFontSize(8);
                doc.text('PROMEDIO/D√çA', margin + 65, 180, {align: 'center'});
                
                // Tarjeta 3: D√≠as activos
                doc.setFillColor(33, 150, 243);
                doc.roundedRect(margin + 90, 160, 40, 25, 2, 2, 'F');
                doc.setFontSize(20);
                doc.text(percentageActiveDays + '%', margin + 110, 170, {align: 'center'});
                doc.setFontSize(8);
                doc.text('D√çAS ACTIVOS', margin + 110, 180, {align: 'center'});
                
                // Tarjeta 4: Nivel de engagement
                var engagementRGB = engagementColor === '#4CAF50' ? [76, 175, 80] : 
                                   engagementColor === '#FF9800' ? [255, 152, 0] : [244, 67, 54];
                doc.setFillColor(engagementRGB[0], engagementRGB[1], engagementRGB[2]);
                doc.roundedRect(margin + 135, 160, 40, 25, 2, 2, 'F');
                doc.setFontSize(12);
                doc.text(engagementLevel, margin + 155, 175, {align: 'center'});
                doc.setFontSize(8);
                doc.text('ENGAGEMENT', margin + 155, 182, {align: 'center'});
                
                // An√°lisis detallado
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('AN√ÅLISIS DETALLADO', margin, 205);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                var analysisText = [
                    '‚Ä¢ Durante el per√≠odo de ' + totalDaysInPeriod + ' d√≠as, se registraron ' + currentStats.totalEntries.toLocaleString() + ' acciones pedag√≥gicas.',
                    '‚Ä¢ El docente mantuvo actividad en ' + totalDaysActive + ' d√≠as (' + percentageActiveDays + '% del per√≠odo total).',
                    '‚Ä¢ Promedio de ' + avgEntriesPerActiveDay + ' acciones por d√≠a activo.',
                    '‚Ä¢ Nivel de engagement clasificado como: ' + engagementLevel,
                    '‚Ä¢ Los datos reflejan el uso real de herramientas pedag√≥gicas digitales en Moodle.'
                ];
                
                var yPos = 215;
                for (var i = 0; i < analysisText.length; i++) {
                    var lines = doc.splitTextToSize(analysisText[i], contentWidth - 10);
                    doc.text(lines, margin + 5, yPos);
                    yPos += lines.length * 5;
                }
                
                // Pie de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('Generado el: ' + new Date().toLocaleString('es-AR'), margin, pageHeight - 10);
                doc.text('UTN - Centro de e-Learning | Analizador de Logs Moodle', pageWidth - margin, pageHeight - 10, {align: 'right'});
                
                // ===== P√ÅGINA 2: GR√ÅFICOS Y AN√ÅLISIS TEMPORAL =====
                doc.addPage();
                
                // Header de p√°gina 2
                doc.setFillColor(227, 30, 36);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('AN√ÅLISIS TEMPORAL Y PATRONES DE ACTIVIDAD', margin, 15);
                
                // Gr√°fico de actividad por d√≠a de la semana
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('DISTRIBUCI√ìN POR D√çA DE LA SEMANA', margin, 45);
                
                // Crear gr√°fico de barras manual
                var weekdays = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
                var weekdaysFull = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
                var weekdayData = weekdaysFull.map(function(day) {
                    return currentStats.activityByWeekday[day] || 0;
                });
                
                var maxValue = Math.max.apply(Math, weekdayData);
                var chartX = margin;
                var chartY = 55;
                var chartWidth = contentWidth;
                var chartHeight = 40;
                var barWidth = chartWidth / 7 - 5;
                
                // Dibujar ejes
                doc.setLineWidth(0.5);
                doc.setDrawColor(200, 200, 200);
                doc.line(chartX, chartY + chartHeight, chartX + chartWidth, chartY + chartHeight); // Eje X
                doc.line(chartX, chartY, chartX, chartY + chartHeight); // Eje Y
                
                // Dibujar barras
                var colors = [
                    [227, 30, 36], [255, 87, 34], [255, 152, 0], [255, 193, 7],
                    [76, 175, 80], [33, 150, 243], [156, 39, 176]
                ];
                
                for (var i = 0; i < weekdayData.length; i++) {
                    var barHeight = maxValue > 0 ? (weekdayData[i] / maxValue) * chartHeight : 0;
                    var barX = chartX + (i * (barWidth + 5)) + 5;
                    var barY = chartY + chartHeight - barHeight;
                    
                    doc.setFillColor(colors[i][0], colors[i][1], colors[i][2]);
                    doc.rect(barX, barY, barWidth, barHeight, 'F');
                    
                    // Etiquetas
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    doc.text(weekdays[i], barX + barWidth/2, chartY + chartHeight + 8, {align: 'center'});
                    
                    // Valores
                    if (weekdayData[i] > 0) {
                        doc.text(weekdayData[i].toString(), barX + barWidth/2, barY - 2, {align: 'center'});
                    }
                }
                
                // An√°lisis semanal
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('AN√ÅLISIS SEMANAL:', margin, 115);
                
                doc.setFont(undefined, 'normal');
                var weekdayAnalysis = analyzeWeekdayActivity(weekdayData, weekdaysFull);
                var weekdayLines = doc.splitTextToSize(weekdayAnalysis, contentWidth);
                var yPosWeek = 125;
                for (var i = 0; i < weekdayLines.length; i++) {
                    doc.text(weekdayLines[i], margin, yPosWeek);
                    yPosWeek += 5;
                }
                
                // Gr√°fico de evoluci√≥n temporal (si hay datos mensuales)
                if (Object.keys(currentStats.entriesPerMonth).length > 1) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('EVOLUCI√ìN TEMPORAL', margin, yPosWeek + 15);
                    
                    var monthlyEntries = Object.entries(currentStats.entriesPerMonth).sort();
                    var monthData = monthlyEntries.map(function(entry) { return entry[1]; });
                    var monthLabels = monthlyEntries.map(function(entry) { return entry[0]; });
                    
                    var lineChartY = yPosWeek + 25;
                    var lineChartHeight = 30;
                    var maxMonthValue = Math.max.apply(Math, monthData);
                    
                    // Dibujar ejes
                    doc.line(chartX, lineChartY + lineChartHeight, chartX + chartWidth, lineChartY + lineChartHeight);
                    doc.line(chartX, lineChartY, chartX, lineChartY + lineChartHeight);
                    
                    // Dibujar l√≠nea de tendencia
                    doc.setDrawColor(227, 30, 36);
                    doc.setLineWidth(2);
                    
                    var pointSpacing = chartWidth / (monthData.length - 1);
                    for (var i = 0; i < monthData.length - 1; i++) {
                        var x1 = chartX + (i * pointSpacing);
                        var y1 = lineChartY + lineChartHeight - ((monthData[i] / maxMonthValue) * lineChartHeight);
                        var x2 = chartX + ((i + 1) * pointSpacing);
                        var y2 = lineChartY + lineChartHeight - ((monthData[i + 1] / maxMonthValue) * lineChartHeight);
                        
                        doc.line(x1, y1, x2, y2);
                        
                        // Puntos
                        doc.setFillColor(227, 30, 36);
                        doc.circle(x1, y1, 1, 'F');
                    }
                    
                    // √öltimo punto
                    if (monthData.length > 0) {
                        var lastX = chartX + ((monthData.length - 1) * pointSpacing);
                        var lastY = lineChartY + lineChartHeight - ((monthData[monthData.length - 1] / maxMonthValue) * lineChartHeight);
                        doc.circle(lastX, lastY, 1, 'F');
                    }
                    
                    // Etiquetas de meses
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    for (var i = 0; i < monthLabels.length; i++) {
                        var labelX = chartX + (i * pointSpacing);
                        doc.text(monthLabels[i], labelX, lineChartY + lineChartHeight + 8, {align: 'center'});
                    }
                }
                
                // ===== P√ÅGINA 3: ACTIVIDADES DETALLADAS =====
                doc.addPage();
                
                // Header de p√°gina 3
                doc.setFillColor(227, 30, 36);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('DETALLE DE ACTIVIDADES PEDAG√ìGICAS', margin, 15);
                
                // Tabla de actividades m√°s frecuentes
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('TOP 15 ACTIVIDADES M√ÅS FRECUENTES', margin, 40);
                
                var sortedEvents = Object.entries(currentStats.eventTypes)
                    .sort(function(a, b) { return b[1] - a[1]; })
                    .slice(0, 15);
                
                // Headers de tabla
                doc.setFillColor(227, 30, 36);
                doc.rect(margin, 50, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('#', margin + 2, 56);
                doc.text('ACTIVIDAD PEDAG√ìGICA', margin + 10, 56);
                doc.text('CANT.', margin + 130, 56);
                doc.text('PORCENTAJE', margin + 150, 56);
                
                // Filas de datos
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                var tableY = 60;
                
                for (var i = 0; i < Math.min(sortedEvents.length, 15); i++) {
                    var event = sortedEvents[i];
                    var percentage = ((event[1] / currentStats.totalEntries) * 100).toFixed(1);
                    
                    // Alternar colores de fila
                    if (i % 2 === 1) {
                        doc.setFillColor(248, 248, 248);
                        doc.rect(margin, tableY - 3, contentWidth, 6, 'F');
                    }
                    
                    doc.setTextColor(0, 0, 0);
                    doc.text((i + 1).toString(), margin + 2, tableY + 2);
                    
                    // Truncar texto si es muy largo
                    var activityText = event[0].length > 50 ? event[0].substring(0, 47) + '...' : event[0];
                    doc.text(activityText, margin + 10, tableY + 2);
                    
                    doc.text(event[1].toString(), margin + 130, tableY + 2);
                    doc.text(percentage + '%', margin + 150, tableY + 2);
                    
                    tableY += 8;
                }
                
                // An√°lisis de actividades
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('AN√ÅLISIS DE PATRONES PEDAG√ìGICOS', margin, tableY + 15);
                
                var activityAnalysis = analyzeActivityPatterns(sortedEvents, currentStats.totalEntries);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                var activityLines = doc.splitTextToSize(activityAnalysis, contentWidth);
                var yPosActivity = tableY + 25;
                
                for (var i = 0; i < activityLines.length; i++) {
                    doc.text(activityLines[i], margin, yPosActivity);
                    yPosActivity += 5;
                }
                
                // Conclusiones y recomendaciones - Calcular altura din√°mica
                var conclusions = generateConclusions(percentageActiveDays, avgEntriesPerPeriod, engagementLevel);
                var conclusionLines = doc.splitTextToSize(conclusions, contentWidth - 10);
                
                // Calcular altura necesaria para el recuadro
                var titleHeight = 8;
                var textHeight = conclusionLines.length * 4;
                var padding = 10;
                var totalBoxHeight = titleHeight + textHeight + padding;
                
                // Verificar si hay espacio suficiente en la p√°gina actual
                var availableSpace = pageHeight - (yPosActivity + 10) - 20; // 20 = margen inferior
                
                if (totalBoxHeight > availableSpace) {
                    // Si no hay espacio, crear nueva p√°gina
                    doc.addPage();
                    
                    // Header de nueva p√°gina
                    doc.setFillColor(227, 30, 36);
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('CONCLUSIONES Y RECOMENDACIONES', margin, 15);
                    
                    yPosActivity = 35; // Reiniciar posici√≥n Y
                    totalBoxHeight = Math.min(totalBoxHeight, pageHeight - yPosActivity - 20);
                }
                
                // Dibujar recuadro con altura calculada
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, yPosActivity + 10, contentWidth, totalBoxHeight, 3, 3, 'F');
                
                // T√≠tulo de la secci√≥n
                doc.setTextColor(227, 30, 36);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('CONCLUSIONES Y RECOMENDACIONES', margin + 5, yPosActivity + 20);
                
                // Contenido del texto
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                var yPosConc = yPosActivity + 28;
                
                for (var i = 0; i < conclusionLines.length && yPosConc < (yPosActivity + 10 + totalBoxHeight - 5); i++) {
                    doc.text(conclusionLines[i], margin + 5, yPosConc);
                    yPosConc += 4;
                }
                
                // Pie de p√°gina final
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('P√°gina 3 de 3 | UTN Centro de e-Learning', margin, pageHeight - 10);
                doc.text('Este reporte es generado autom√°ticamente basado en logs de Moodle', pageWidth - margin, pageHeight - 10, {align: 'right'});
                
                // Guardar PDF
                var fileName = 'Reporte_Completo_' + teacherName.replace(/\s+/g, '_') + '_' + 
                               new Date().toISOString().slice(0, 10) + '.pdf';
                doc.save(fileName);
                
                showAlert('Reporte PDF completo generado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando PDF completo:', error);
                showAlert('Error al generar el reporte PDF: ' + error.message, 'error');
            }
        }
        
        // Funci√≥n auxiliar para analizar actividad semanal
        function analyzeWeekdayActivity(weekdayData, weekdayNames) {
            var maxIndex = weekdayData.indexOf(Math.max.apply(Math, weekdayData));
            var minIndex = weekdayData.indexOf(Math.min.apply(Math, weekdayData));
            var total = weekdayData.reduce(function(a, b) { return a + b; }, 0);
            
            var analysis = 'El d√≠a de mayor actividad es ' + weekdayNames[maxIndex] + ' con ' + weekdayData[maxIndex] + ' acciones. ';
            
            if (weekdayData[minIndex] > 0) {
                analysis += 'El d√≠a de menor actividad es ' + weekdayNames[minIndex] + ' con ' + weekdayData[minIndex] + ' acciones. ';
            }
            
            // Analizar patrones
            var weekdaySum = weekdayData.slice(0, 5).reduce(function(a, b) { return a + b; }, 0);
            var weekendSum = weekdayData.slice(5).reduce(function(a, b) { return a + b; }, 0);
            var weekdayPercentage = ((weekdaySum / total) * 100).toFixed(1);
            
            analysis += 'La actividad se concentra en d√≠as h√°biles (' + weekdayPercentage + '% del total). ';
            
            if (weekendSum > 0) {
                analysis += 'Se registra actividad de fin de semana (' + ((weekendSum / total) * 100).toFixed(1) + '%), ';
                analysis += 'indicando dedicaci√≥n extra del docente fuera del horario laboral est√°ndar.';
            }
            
            return analysis;
        }
        
        // Funci√≥n auxiliar para analizar patrones de actividades
        function analyzeActivityPatterns(sortedEvents, totalEntries) {
            if (sortedEvents.length === 0) return 'No se encontraron actividades para analizar.';
            
            var topActivity = sortedEvents[0];
            var topPercentage = ((topActivity[1] / totalEntries) * 100).toFixed(1);
            
            var analysis = 'La actividad m√°s frecuente es "' + topActivity[0] + '" representando el ' + topPercentage + '% del total. ';
            
            // Analizar concentraci√≥n de actividades
            var top3Sum = sortedEvents.slice(0, 3).reduce(function(sum, event) { return sum + event[1]; }, 0);
            var top3Percentage = ((top3Sum / totalEntries) * 100).toFixed(1);
            
            analysis += 'Las 3 actividades principales concentran el ' + top3Percentage + '% de todas las acciones, ';
            
            if (parseFloat(top3Percentage) > 70) {
                analysis += 'indicando un patr√≥n de uso concentrado en actividades espec√≠ficas. ';
            } else {
                analysis += 'mostrando una distribuci√≥n diversificada de actividades pedag√≥gicas. ';
            }
            
            // Identificar tipos de actividades predominantes
            var viewingActivities = sortedEvents.filter(function(event) {
                return event[0].toLowerCase().includes('visto') || 
                       event[0].toLowerCase().includes('view') ||
                       event[0].toLowerCase().includes('viewed');
            }).length;
            
            var managementActivities = sortedEvents.filter(function(event) {
                return event[0].toLowerCase().includes('created') || 
                       event[0].toLowerCase().includes('updated') ||
                       event[0].toLowerCase().includes('graded');
            }).length;
            
            if (viewingActivities > managementActivities) {
                analysis += 'Predominan actividades de supervisi√≥n y seguimiento estudiantil.';
            } else if (managementActivities > viewingActivities) {
                analysis += 'Predominan actividades de gesti√≥n y creaci√≥n de contenidos.';
            } else {
                analysis += 'Existe un equilibrio entre actividades de supervisi√≥n y gesti√≥n.';
            }
            
            return analysis;
        }
        
        // Funci√≥n auxiliar para generar conclusiones
        function generateConclusions(percentageActiveDays, avgEntriesPerPeriod, engagementLevel) {
            var conclusions = '';
            
            // An√°lisis de engagement
            conclusions += '‚Ä¢ NIVEL DE ENGAGEMENT: ' + engagementLevel + ' - ';
            if (engagementLevel === 'ALTO') {
                conclusions += 'El docente demuestra una presencia consistente y activa en la plataforma, indicando un compromiso s√≥lido con la ense√±anza digital. ';
            } else if (engagementLevel === 'MODERADO') {
                conclusions += 'El docente muestra un uso regular de la plataforma con oportunidades de incrementar la frecuencia de uso. ';
            } else {
                conclusions += 'Se recomienda incrementar la frecuencia de uso de la plataforma para maximizar el potencial pedag√≥gico digital. ';
            }
            
            // An√°lisis de frecuencia
            conclusions += '‚Ä¢ FRECUENCIA DE USO: Con un promedio de ' + avgEntriesPerPeriod + ' acciones por d√≠a, ';
            if (parseFloat(avgEntriesPerPeriod) > 10) {
                conclusions += 'el docente mantiene una interacci√≥n muy activa con la plataforma. ';
            } else if (parseFloat(avgEntriesPerPeriod) > 5) {
                conclusions += 'el docente muestra una interacci√≥n moderada con herramientas digitales. ';
            } else {
                conclusions += 'existe potencial para incrementar la interacci√≥n con las herramientas pedag√≥gicas disponibles. ';
            }
            
            // Recomendaciones espec√≠ficas
            conclusions += '‚Ä¢ RECOMENDACIONES: ';
            if (engagementLevel === 'ALTO') {
                conclusions += 'Continuar con las pr√°cticas actuales y considerar compartir estrategias exitosas con otros docentes. Explorar funcionalidades avanzadas de Moodle. ';
            } else if (engagementLevel === 'MODERADO') {
                conclusions += 'Implementar recordatorios para revisi√≥n diaria de la plataforma. Explorar nuevas herramientas como foros, cuestionarios autom√°ticos y seguimiento de progreso estudiantil. ';
            } else {
                conclusions += 'Programar sesiones de capacitaci√≥n en herramientas digitales. Establecer rutinas diarias de revisi√≥n de plataforma. Comenzar con funcionalidades b√°sicas como mensajer√≠a y calificaciones. ';
            }
            
            // An√°lisis de continuidad
            conclusions += '‚Ä¢ CONTINUIDAD: La actividad se distribuye en ' + percentageActiveDays + '% del per√≠odo evaluado, ';
            if (parseFloat(percentageActiveDays) > 70) {
                conclusions += 'demostrando excelente consistencia en el uso de tecnolog√≠a educativa.';
            } else if (parseFloat(percentageActiveDays) > 40) {
                conclusions += 'mostrando buena regularidad con oportunidades de mejora en la continuidad.';
            } else {
                conclusions += 'sugiriendo la necesidad de establecer rutinas m√°s regulares de uso de la plataforma.';
            }
            
            return conclusions;
        }

        // Funci√≥n para exportar a CSV
        function exportToCSV() {
            try {
                var csvContent = 'data:text/csv;charset=utf-8,';
                
                // Header del reporte
                csvContent += 'Reporte de Actividad Docente - UTN\n';
                csvContent += 'Docente,' + teacherName + '\n';
                csvContent += 'Curso,' + courseInfo.courseName + '\n';
                csvContent += 'Per√≠odo,' + courseInfo.period + '\n';
                csvContent += 'Fecha del reporte,' + courseInfo.reportDate + '\n\n';
                
                // Estad√≠sticas principales
                csvContent += 'Estad√≠sticas Principales\n';
                csvContent += 'M√©trica,Valor\n';
                csvContent += 'Total de acciones,' + currentStats.totalEntries + '\n';
                csvContent += 'D√≠as con actividad,' + Object.keys(currentStats.entriesPerDay).length + '\n';
                csvContent += 'D√≠as del per√≠odo total,' + currentStats.totalDaysInPeriod + '\n';
                csvContent += 'Porcentaje de d√≠as activos,' + ((Object.keys(currentStats.entriesPerDay).length / currentStats.totalDaysInPeriod) * 100).toFixed(1) + '%\n';
                csvContent += 'Promedio por d√≠a del per√≠odo,' + (currentStats.totalEntries / currentStats.totalDaysInPeriod).toFixed(1) + '\n\n';
                
                // Actividad por d√≠a de la semana
                csvContent += 'Actividad por D√≠a de la Semana\n';
                csvContent += 'D√≠a,Acciones\n';
                var weekdays = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
                for (var i = 0; i < weekdays.length; i++) {
                    csvContent += weekdays[i] + ',' + (currentStats.activityByWeekday[weekdays[i]] || 0) + '\n';
                }
                csvContent += '\n';
                
                // Tipos de eventos
                csvContent += 'Tipos de Actividades\n';
                csvContent += 'Actividad,Cantidad,Porcentaje\n';
                var sortedEvents = Object.entries(currentStats.eventTypes)
                    .sort(function(a, b) { return b[1] - a[1]; });
                
                for (var i = 0; i < sortedEvents.length; i++) {
                    var event = sortedEvents[i];
                    var percentage = ((event[1] / currentStats.totalEntries) * 100).toFixed(1);
                    csvContent += '"' + event[0] + '",' + event[1] + ',' + percentage + '%\n';
                }
                
                // Crear y descargar archivo
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'reporte_actividad_' + teacherName.replace(/\s+/g, '_') + '.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('Reporte CSV exportado exitosamente', 'success');
            } catch (error) {
                console.error('Error exportando CSV:', error);
                showAlert('Error al exportar CSV', 'error');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            var fileInput = document.getElementById('fileInput');
            var uploadArea = document.querySelector('.upload-area');

            // Manejar selecci√≥n de archivo
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // Manejar drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--utn-dark-red)';
                uploadArea.style.background = '#FFF0F0';
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--utn-red)';
                uploadArea.style.background = '#FDF5F5';
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--utn-red)';
                uploadArea.style.background = '#FDF5F5';
                
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        });
    </script>
</body>
</html>
